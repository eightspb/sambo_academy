# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Multiple rows were found

## –ü—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
- ‚ùå –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- ‚ùå –û—à–∏–±–∫–∞ 500 Internal Server Error –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ `/api/students`
- ‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:
```
sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when one or none was required
File "/app/app/api/students.py", line 56, in get_students
    active_sub = sub_result.scalar_one_or_none()
```

---

## –ü—Ä–∏—á–∏–Ω–∞

–í –º–µ—Ç–æ–¥–µ `get_students()` (–∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–∞—Ö API) –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –º–µ—Ç–æ–¥ `scalar_one_or_none()`:

```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalar_one_or_none()  # ‚ùå –û–®–ò–ë–ö–ê!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –£ —Å—Ç—É–¥–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
- –°—Ç–∞—Ä—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω
- –°–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç
- –ù–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Å—Ç–∞—Ä—ã–π

–ú–µ—Ç–æ–¥ `scalar_one_or_none()` –æ–∂–∏–¥–∞–µ—Ç:
- **0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` ‚úÖ
- **1 —Ä–µ–∑—É–ª—å—Ç–∞—Ç** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ‚úÖ
- **2+ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚Üí **–≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ** ‚ùå

---

## –†–µ—à–µ–Ω–∏–µ

–ó–∞–º–µ–Ω–∏–ª `scalar_one_or_none()` –Ω–∞ `scalars().first()` –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö:

```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalars().first()  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û!
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `scalars().first()`:**
- **0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` ‚úÖ
- **1 —Ä–µ–∑—É–ª—å—Ç–∞—Ç** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ‚úÖ
- **2+ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–ø–µ—Ä–≤—ã–π** (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π) ‚úÖ

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã

### –§–∞–π–ª: `app/api/students.py`

#### 1. GET /api/students (—Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)

**–ë—ã–ª–æ:**
```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalar_one_or_none()  # ‚ùå
```

**–°—Ç–∞–ª–æ:**
```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalars().first()  # ‚úÖ
```

**–°—Ç—Ä–æ–∫–∞:** 56

---

#### 2. POST /api/students (—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞)

**–ë—ã–ª–æ:**
```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalar_one_or_none()  # ‚ùå
```

**–°—Ç–∞–ª–æ:**
```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalars().first()  # ‚úÖ
```

**–°—Ç—Ä–æ–∫–∞:** 113

---

#### 3. PUT /api/students/{id} (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞)

**–ë—ã–ª–æ:**
```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalar_one_or_none()  # ‚ùå
```

**–°—Ç–∞–ª–æ:**
```python
sub_result = await db.execute(sub_query)
active_sub = sub_result.scalars().first()  # ‚úÖ
```

**–°—Ç—Ä–æ–∫–∞:** 188

---

## –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:

```python
sub_query = select(Subscription).where(
    Subscription.student_id == student.id,
    Subscription.is_active == True
).order_by(Subscription.start_date.desc())  # ‚Üê –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
```

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** 
- –ó–∞–ø—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ `start_date DESC` (–Ω–æ–≤—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–≤—ã–µ)
- –ú–µ—Ç–æ–¥ `.first()` –±–µ—Ä–µ—Ç **–ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç** = **—Å–∞–º—ã–π –Ω–æ–≤—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
‚úÖ –ï—Å–ª–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –æ–¥–∏–Ω ‚Üí –±–µ—Ä–µ–º –µ–≥–æ  
‚úÖ –ï—Å–ª–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Üí –±–µ—Ä–µ–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π  
‚úÖ –ï—Å–ª–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `None`  

---

## –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ:**

```python
# –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã
old_subs = await db.execute(
    select(Subscription).where(
        Subscription.student_id == student_id,
        Subscription.is_active == True
    )
)
for old_sub in old_subs.scalars():
    old_sub.is_active = False

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
new_sub = Subscription(...)
db.add(new_sub)
```

2. **–î–æ–±–∞–≤–∏—Ç—å unique constraint –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:**

```sql
-- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
CREATE UNIQUE INDEX idx_one_active_subscription 
ON subscriptions (student_id) 
WHERE is_active = true;
```

–ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å **—Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ**, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å.

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.first()` –≤–µ–∑–¥–µ:**

–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –≥–∏–±–∫–æ ‚úÖ

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É:**
   ```
   http://localhost:8000
   ```
   ‚úÖ –î–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ 500
   - –ó–∞–ø—Ä–æ—Å—ã –∫ `/api/students` –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 OK

3. **–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¢—É—Ä–Ω–∏—Ä—ã:**
   ```
   http://localhost:8000/tournaments
   ```
   ‚úÖ –î–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
ERROR: sqlalchemy.exc.MultipleResultsFound: Multiple rows were found
INFO: 172.20.0.1:36186 - "GET /api/students?is_active=true HTTP/1.1" 500 Internal Server Error
```

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
INFO: 172.20.0.1:40364 - "GET /api/students HTTP/1.1" 200 OK
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (N+1 –∑–∞–ø—Ä–æ—Å–æ–≤):

–¢–µ–∫—É—â–∏–π –∫–æ–¥ –¥–µ–ª–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞:
```python
for student in students:
    # –û—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
    active_sub = await db.execute(sub_query)
```

**–ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é JOIN:**
```python
query = select(Student, Subscription).outerjoin(
    Subscription,
    and_(
        Subscription.student_id == Student.id,
        Subscription.is_active == True
    )
).order_by(Student.full_name, Subscription.start_date.desc())
```

**–ù–æ:**
- –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –¢–µ–∫—É—â–∏–π –∫–æ–¥ –ø—Ä–æ—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

| –§–∞–π–ª | –ú–µ—Ç–æ–¥ | –°—Ç—Ä–æ–∫–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|-------|--------|-----------|
| `app/api/students.py` | `get_students()` | 56 | `scalar_one_or_none()` ‚Üí `scalars().first()` |
| `app/api/students.py` | `create_student()` | 113 | `scalar_one_or_none()` ‚Üí `scalars().first()` |
| `app/api/students.py` | `update_student()` | 188 | `scalar_one_or_none()` ‚Üí `scalars().first()` |

**–í—Å–µ–≥–æ:** 3 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏:

```sql
SELECT 
    s.full_name,
    COUNT(sub.id) as active_subscriptions,
    STRING_AGG(sub.start_date::text, ', ') as start_dates
FROM students s
JOIN subscriptions sub ON sub.student_id = s.id
WHERE sub.is_active = true
GROUP BY s.id, s.full_name
HAVING COUNT(sub.id) > 1
ORDER BY active_subscriptions DESC;
```

**–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –≠—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏
- –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–∏–º–∏
- –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –≤—Ä—É—á–Ω—É—é

---

## –†–µ–∑—é–º–µ

### –ü—Ä–æ–±–ª–µ–º–∞:
‚ùå –û—à–∏–±–∫–∞ `MultipleResultsFound` –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞—Ö

### –†–µ—à–µ–Ω–∏–µ:
‚úÖ –ó–∞–º–µ–Ω–∞ `scalar_one_or_none()` –Ω–∞ `scalars().first()`

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ  
‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏  

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-10-06  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û
