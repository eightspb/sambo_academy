# 📅 Переработка системы посещаемости

## ✨ Что изменено

Система посещаемости полностью переработана для удобства работы с датами и редактирования записей.

---

## 🎯 Основные изменения

### 1. **Убрано время из посещаемости**
- Раньше: `session_date` = `datetime` (дата + время)
- Теперь: `session_date` = `date` (только дата)

### 2. **Календарный интерфейс**
- Выбор месяца и года
- Календарь с днями месяца в виде кнопок
- Автоматическое выделение текущего дня
- Визуальная индикация дней с посещаемостью

### 3. **Редактирование посещаемости**
- Можно изменять существующие отметки
- При сохранении обновляются существующие записи
- Нельзя создать дубликаты (ученик + группа + дата = уникально)

---

## 📝 Технические детали

### Изменения в базе данных

**Миграция:** `migrations/004_change_attendance_date_type.sql`

```sql
-- Изменение типа с TIMESTAMP на DATE
ALTER TABLE attendances ADD COLUMN session_date_new DATE;
UPDATE attendances SET session_date_new = session_date::DATE;
ALTER TABLE attendances DROP COLUMN session_date;
ALTER TABLE attendances RENAME COLUMN session_date_new TO session_date;

-- Уникальное ограничение
ALTER TABLE attendances 
ADD CONSTRAINT uq_attendance_student_group_date 
UNIQUE (student_id, group_id, session_date);
```

### Изменения в моделях

**Файл:** `app/models/attendance.py`

```python
from datetime import date  # Изменено с datetime

class Attendance(Base):
    __tablename__ = "attendances"
    __table_args__ = (
        UniqueConstraint('student_id', 'group_id', 'session_date', 
                        name='uq_attendance_student_group_date'),
    )
    
    session_date: Mapped[date] = mapped_column(Date, nullable=False, index=True)
```

### Изменения в API

**Файл:** `app/api/attendance.py`

#### Новый endpoint для получения посещаемости за дату:

```python
@router.get("/date/{group_id}/{session_date}")
async def get_attendance_by_date(
    group_id: uuid.UUID,
    session_date: str,  # Format: YYYY-MM-DD
    ...
):
    """Получить посещаемость за конкретную дату и группу."""
```

**Возвращает:**
- Всех учеников группы
- Их статус посещения (если отмечен)
- ID записи посещаемости (для редактирования)

#### Обновлен endpoint сохранения:

```python
@router.post("/mark", ...)
async def mark_attendance(...):
    """Отметить посещаемость. Обновляет существующие записи."""
    
    # Проверяет существующие записи
    # Обновляет если есть, создает если нет
```

---

## 🎨 Новый интерфейс

### Структура страницы

```
┌────────────────────────────────────────────┐
│ Посещаемость                               │
├────────────────────────────────────────────┤
│ Группа: [Выбор группы ▼]                  │
│ Год: [2025 ▼]   Месяц: [Октябрь ▼]       │
├────────────────────────────────────────────┤
│          КАЛЕНДАРЬ ДНЕЙ                    │
│ Пн  Вт  Ср  Чт  Пт  Сб  Вс               │
│     1   2   3   4  [5]  6                 │
│  7   8   9  10  11  12  13                │
│ 14  15  16  17  18  19  20                │
│ 21  22  23  24  25  26  27                │
│ 28  29  30  31                             │
├────────────────────────────────────────────┤
│    ПОСЕЩАЕМОСТЬ ЗА 5 ОКТЯБРЯ 2025         │
│                                            │
│ Иванов Иван                                │
│ [✓ Присутствовал] [✗ Отсутствовал] [→ Перенос] │
│                                            │
│ Петрова Мария                              │
│ [✓ Присутствовал] [✗ Отсутствовал] [→ Перенос] │
│                                            │
│        [Сохранить изменения]               │
└────────────────────────────────────────────┘
```

### Визуальные индикаторы

**Кнопки дней:**
- 🔵 Синяя рамка - текущий день
- 🟢 Зеленый фон - день с отметками посещаемости
- ⚪ Выбранный день - синий фон

**Статус кнопки:**
- 🟢 Зеленая - Присутствовал
- 🔴 Красная - Отсутствовал
- 🟡 Желтая - Перенос

---

## 💡 Как использовать

### Сценарий 1: Отметить посещаемость за сегодня

1. Откройте **Посещаемость**
2. Выберите **Группу**
3. Календарь откроется на текущем месяце
4. Текущий день будет автоматически выбран
5. Отметьте учеников
6. Нажмите **"Сохранить изменения"**

### Сценарий 2: Исправить посещаемость за прошлый день

1. Выберите **Группу**
2. Кликните на **нужный день** в календаре
3. Измените отметки учеников
4. Нажмите **"Сохранить изменения"**
5. ✅ Существующие записи обновятся

### Сценарий 3: Просмотр посещаемости за другой месяц

1. Выберите **Месяц** и **Год**
2. Календарь обновится
3. Дни с отметками будут выделены зеленым
4. Кликните на любой день для просмотра

---

## 🔍 Тестирование

### Автоматические тесты

Запустите:
```bash
docker-compose exec app python test_attendance_changes.py
```

**Что проверяется:**
- ✅ Тип session_date = date (не datetime)
- ✅ Создание новых записей
- ✅ Уникальное ограничение работает
- ✅ Существующие записи корректны

### Ручное тестирование

**1. Проверка календаря:**
- [ ] Календарь отображается корректно
- [ ] Текущий день выделен
- [ ] Можно переключать месяцы

**2. Проверка отметок:**
- [ ] Отметить посещаемость за сегодня
- [ ] Изменить отметки за вчера
- [ ] Попробовать сохранить дважды (должно обновить)

**3. Проверка групп:**
- [ ] Переключение между группами работает
- [ ] Данные обновляются корректно

---

## 📊 Статистика

**Результаты миграции:**
- Обновлено записей: 52
- Добавлено ограничений: 1
- Создано индексов: 1

**Проверка:**
```
✅ session_date тип: <class 'datetime.date'>
✅ Создана запись для Чекалев Егор
✅ Уникальное ограничение работает корректно
✅ Всего записей: 53
✅ Уникальных дат: 2
```

---

## 🔧 Troubleshooting

### Проблема: "Дубликат уже существует"

**Причина:** Пытаетесь создать запись для студента, который уже отмечен в этот день.

**Решение:** Это нормально! Просто измените статус и сохраните - запись обновится.

### Проблема: "Календарь не отображается"

**Причина:** Не выбрана группа.

**Решение:** Выберите группу из выпадающего списка.

### Проблема: "Не сохраняются изменения"

**Причина:** Не отмечен ни один ученик.

**Решение:** Отметьте хотя бы одного ученика перед сохранением.

---

## 🎯 Преимущества новой системы

### ✅ Упрощение
- Не нужно указывать время
- Один день = одна отметка
- Интуитивный календарный интерфейс

### ✅ Надежность
- Невозможно создать дубликаты
- Автоматическое обновление существующих записей
- Валидация на уровне БД

### ✅ Удобство
- Быстрый доступ к любому дню
- Визуальная индикация отмеченных дней
- Редактирование без удаления

---

## 📚 API документация

### GET `/api/attendance/date/{group_id}/{session_date}`

**Описание:** Получить посещаемость за конкретную дату.

**Параметры:**
- `group_id` - UUID группы
- `session_date` - Дата в формате YYYY-MM-DD

**Ответ:**
```json
[
  {
    "student_id": "uuid",
    "full_name": "Иванов Иван",
    "birth_date": "2010-01-01",
    "status": "present",  // или null если не отмечен
    "attendance_id": "uuid",  // или null
    "notes": null
  }
]
```

### POST `/api/attendance/mark`

**Описание:** Отметить/обновить посещаемость.

**Тело запроса:**
```json
{
  "group_id": "uuid",
  "session_date": "2025-10-05",
  "attendances": [
    {
      "student_id": "uuid",
      "status": "present",
      "notes": null
    }
  ]
}
```

**Поведение:**
- Если запись существует → обновляет
- Если записи нет → создает новую
- Невозможно создать дубликат

---

## 🔄 Миграция данных

Все существующие записи автоматически конвертированы:
- `2025-10-05 14:30:00` → `2025-10-05`
- Время отброшено
- Данные сохранены

**Backup старой версии:**
- `templates/attendance_old.html` - старый интерфейс (на случай отката)

---

## ✨ Готово к использованию!

**URL:** http://localhost:8000/attendance

**Все тесты:** ✅ PASSED

**Готово для продакшена:** ✅ YES

---

**Дата обновления:** 2025-10-05  
**Версия:** 2.0  
**Статус:** ГОТОВО К ИСПОЛЬЗОВАНИЮ ✅
