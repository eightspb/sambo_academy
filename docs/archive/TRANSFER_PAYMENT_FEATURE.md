# 💰 Автоматическая компенсация за переносы занятий

## 🎯 Что это

При отметке ученика статусом **"Перенос"** система автоматически создает частичную оплату на следующий месяц в размере стоимости одного занятия.

---

## ✨ Как это работает

### Пример 1: Абонемент на 8 занятий

**Исходные данные:**
- Группа: Младшие ПН-СР-ПТ (junior)
- Абонемент: 8 занятий
- Стоимость абонемента: 3200₽
- Дата переноса: 15 октября 2025

**Расчет:**
```
Стоимость 1 занятия = 3200₽ / 8 = 400₽
```

**Что происходит:**
1. Ученик отмечен как "Перенос" 15.10.2025
2. Система создает payment на **1 ноября 2025**
3. Сумма: **400₽**
4. Примечание: "Автоматическая компенсация за перенос от 15.10.2025"

**Результат в следующем месяце:**
```
Ноябрь 2025:
- Стандартная цена абонемента: 3200₽
- Уже оплачено (компенсация): 400₽
- Осталось оплатить: 2800₽ ✅
```

---

### Пример 2: Абонемент на 12 занятий

**Исходные данные:**
- Группа: Старшие ВТ-ЧТ (senior)
- Абонемент: 12 занятий
- Стоимость абонемента: 4800₽
- Дата переноса: 20 октября 2025

**Расчет:**
```
Стоимость 1 занятия = 4800₽ / 12 = 400₽
```

**Что происходит:**
1. Ученик отмечен как "Перенос" 20.10.2025
2. Система создает payment на **1 ноября 2025**
3. Сумма: **400₽**
4. Примечание: "Автоматическая компенсация за перенос от 20.10.2025"

---

### Пример 3: Несколько переносов в месяце

**Ситуация:**
- Ученик: Матвей
- Группа: Младшие (junior), 8 занятий = 3200₽
- Октябрь: 2 переноса (5-го и 19-го октября)

**Что происходит:**
1. **5 октября:** Перенос → создается payment на ноябрь: 400₽
2. **19 октября:** Перенос → создается еще один payment на ноябрь: 400₽

**Результат в ноябре:**
```
Ноябрь 2025:
- Стандартная цена: 3200₽
- Компенсация 1: 400₽
- Компенсация 2: 400₽
- ИТОГО уже оплачено: 800₽
- Осталось оплатить: 2400₽ ✅
```

---

## 📋 Техническая реализация

### Когда создается компенсация

Компенсация создается в двух случаях:

#### 1. Новая отметка "Перенос"
```
Ученик еще не отмечен на эту дату
↓
Тренер ставит "Перенос"
↓
Создается attendance + payment
```

#### 2. Изменение статуса на "Перенос"
```
Ученик отмечен как "Присутствовал" или "Отсутствовал"
↓
Тренер меняет на "Перенос"
↓
Создается payment
```

---

### Условия создания

Компенсация создается **ТОЛЬКО если:**

✅ Статус = "Перенос"  
✅ У ученика есть активный абонемент  
✅ Удалось получить информацию о группе  
✅ Удалось получить актуальные цены  

❌ **НЕ создается если:**
- Нет активного абонемента
- Нет информации о группе
- Нет актуальных цен в системе

---

### Расчет стоимости одного занятия

```python
# Определяем тип абонемента
if subscription_type == "8_sessions":
    total_price = junior_8_price или senior_8_price  # в зависимости от группы
    sessions_count = 8
else:  # "12_sessions"
    total_price = junior_12_price или senior_12_price
    sessions_count = 12

# Рассчитываем стоимость одного занятия
session_cost = total_price / sessions_count
```

**Примеры:**
| Группа | Абонемент | Цена абонемента | Стоимость 1 занятия |
|--------|-----------|-----------------|---------------------|
| Junior | 8 занятий | 3200₽ | **400₽** |
| Junior | 12 занятий | 4500₽ | **375₽** |
| Senior | 8 занятий | 3600₽ | **450₽** |
| Senior | 12 занятий | 4800₽ | **400₽** |

---

### Дата компенсации

Компенсация создается на **первое число следующего месяца:**

```python
# Если перенос был 15 октября 2025
next_month = session_date + relativedelta(months=1)  # 15 ноября
next_month = next_month.replace(day=1)                # 1 ноября

payment_date = 1 ноября 2025
month = 11
year = 2025
```

**Примеры:**
| Дата переноса | Дата компенсации |
|--------------|------------------|
| 15 октября 2025 | **1 ноября 2025** |
| 31 декабря 2025 | **1 января 2026** |
| 1 февраля 2026 | **1 марта 2026** |

---

## 📊 Как это видно в интерфейсе

### Страница "Платежи"

При выборе месяца (например, ноябрь) вы увидите:

```
┌────────────────────────────────────────────────────────────────┐
│ № ФИО ученика    Тип          Стандартная  Фактическая  Статус│
│                  абонемента   цена         сумма               │
├────────────────────────────────────────────────────────────────┤
│ 1 Иванов Иван    8 занятий   3200₽        400₽         Частично│
│                                            (компенсация)        │
│                                                                 │
│   Действия: [Стандартная оплата] [Оплатить]                   │
└────────────────────────────────────────────────────────────────┘
```

**Кнопка "Детали":**
```
┌─────────────────────────────────────┐
│ Детали оплаты                       │
├─────────────────────────────────────┤
│ Ученик: Иванов Иван                 │
│ Тип: 8 занятий                      │
│ Стандартная цена: 3200₽             │
│ Фактическая сумма: 400₽             │
│ Дата: 01.11.2025                    │
│ Статус: Частично                    │
│                                     │
│ Примечание:                         │
│ Автоматическая компенсация за       │
│ перенос от 15.10.2025              │
└─────────────────────────────────────┘
```

---

### Несколько компенсаций

Если было **несколько переносов**, каждый создает **отдельный payment**:

```
Ноябрь 2025 - Иванов Иван:

Payment 1:
  - Сумма: 400₽
  - Примечание: "Автоматическая компенсация за перенос от 05.10.2025"

Payment 2:
  - Сумма: 400₽
  - Примечание: "Автоматическая компенсация за перенос от 19.10.2025"

ИТОГО уже оплачено: 800₽
Осталось оплатить: 2400₽ (3200₽ - 800₽)
```

---

## 💡 Практические сценарии

### Сценарий 1: Болезнь ученика

**Ситуация:**
- Октябрь: ученик заболел, пропустил 1 занятие
- Тренер поставил "Перенос"

**Результат:**
- Ученик получает компенсацию 400₽ на ноябрь
- В ноябре платит не 3200₽, а 2800₽
- Фактически получает свои 8 оплаченных занятий

---

### Сценарий 2: Праздник

**Ситуация:**
- 23 февраля - выходной
- Всей группе (10 человек) поставили "Перенос"

**Результат:**
- Каждому ученику создается компенсация на март
- В марте все платят на 400₽ меньше
- Группа не теряет деньги из-за праздника

---

### Сценарий 3: Индивидуальная договоренность

**Ситуация:**
- Родитель предупредил, что ребенок не придет 3 занятия
- Договорились об отработке в другой группе

**Октябрь:**
```
05.10 - Перенос → компенсация 400₽ на ноябрь
12.10 - Перенос → компенсация 400₽ на ноябрь  
19.10 - Перенос → компенсация 400₽ на ноябрь

Итого: 1200₽ компенсации
```

**Ноябрь:**
```
Ученик ходит в свою группу + 3 раза отработал в другой
Оплата за ноябрь: 3200₽ - 1200₽ = 2000₽
```

---

## ⚙️ Техническая информация

### База данных

**Таблица:** `payments`

**Поля:**
```sql
id: UUID
student_id: UUID
subscription_type: VARCHAR ('8_sessions' или '12_sessions')
amount: DECIMAL(10, 2)          -- Стоимость 1 занятия
standard_price: DECIMAL(10, 2)  -- Полная стоимость абонемента
payment_date: DATE               -- 1-е число следующего месяца
month: INTEGER                   -- Месяц (1-12)
year: INTEGER                    -- Год
notes: TEXT                      -- "Автоматическая компенсация за перенос от ..."
created_at: TIMESTAMP
```

---

### API

**Endpoint:** `POST /api/attendance/mark`

**Логика:**
```python
if status == 'transferred' and subscription:
    # Получить группу
    group = get_group(group_id)
    
    # Получить актуальные цены
    prices = get_latest_subscription_prices()
    
    # Рассчитать стоимость занятия
    if subscription.type == '8_sessions':
        price = prices.junior_8 if group.age_group == 'junior' else prices.senior_8
        session_cost = price / 8
    else:
        price = prices.junior_12 if group.age_group == 'junior' else prices.senior_12
        session_cost = price / 12
    
    # Создать payment на следующий месяц
    next_month = session_date + relativedelta(months=1)
    next_month = next_month.replace(day=1)
    
    payment = Payment(
        student_id=student_id,
        subscription_type=subscription.type,
        amount=session_cost,
        standard_price=price,
        payment_date=next_month,
        month=next_month.month,
        year=next_month.year,
        notes=f"Автоматическая компенсация за перенос от {session_date}"
    )
    db.add(payment)
```

---

### Зависимости

**Добавлена библиотека:**
```python
python-dateutil==2.9.0
```

**Для вычисления следующего месяца:**
```python
from dateutil.relativedelta import relativedelta

next_month = current_date + relativedelta(months=1)
```

---

## 🔍 Проверка работы

### Тестирование:

1. **Откройте страницу Посещаемость**
   ```
   http://localhost:8000/attendance
   ```

2. **Выберите группу и дату (например, сегодня)**

3. **Отметьте ученика как "Перенос"**
   - Нажмите желтую кнопку "→ Перенос"
   - Нажмите "Сохранить"

4. **Откройте страницу Платежи**
   ```
   http://localhost:8000/payments
   ```

5. **Выберите следующий месяц**
   - Если отметили в октябре → выберите ноябрь

6. **Проверьте результат:**
   ```
   ✅ Видите частичную оплату
   ✅ Сумма = стоимость 1 занятия
   ✅ Примечание о компенсации
   ✅ Осталось оплатить = полная цена - компенсация
   ```

---

### Проверка в БД:

```sql
-- Проверить созданные компенсации
SELECT 
    p.id,
    s.full_name,
    p.amount,
    p.payment_date,
    p.notes
FROM payments p
JOIN students s ON s.id = p.student_id
WHERE p.notes LIKE '%компенсация%'
ORDER BY p.payment_date DESC;
```

**Ожидаемый результат:**
```
id  | full_name    | amount | payment_date | notes
----|--------------|--------|--------------|---------------------------
... | Иванов Иван  | 400.00 | 2025-11-01   | Автоматическая компенса...
... | Петров Петр  | 375.00 | 2025-11-01   | Автоматическая компенса...
```

---

## ⚠️ Важные моменты

### 1. Дублирование компенсаций

**Проблема:**
Если дважды отметить ученика как "Перенос" (удалить и снова отметить), создастся **две компенсации**.

**Решение:**
Система проверяет **изменение статуса**. Если статус уже был "Перенос" и остается "Перенос", компенсация НЕ создается повторно.

---

### 2. Удаление переноса

**Проблема:**
Если тренер отметил "Перенос", а потом передумал и поставил "Присутствовал", компенсация **остается**.

**Текущее поведение:**
Компенсация НЕ удаляется автоматически.

**Рекомендация:**
Тренер должен вручную удалить лишний payment на странице платежей (кнопка "Отменить оплату").

---

### 3. Отсутствие активного абонемента

**Проблема:**
У ученика нет активного абонемента.

**Поведение:**
Компенсация **НЕ создается**. Перенос отмечается, но payment не добавляется.

**Рекомендация:**
Убедитесь, что у ученика есть активный абонемент перед отметкой переноса.

---

### 4. Изменение цен

**Проблема:**
Цены абонементов изменились между октябрем и ноябрем.

**Поведение:**
Компенсация рассчитывается по **ценам на момент переноса** (октябрь).

**Пример:**
```
Октябрь: 8 занятий = 3200₽ → компенсация 400₽
Ноябрь: 8 занятий = 3600₽ (новая цена)

Результат:
- Компенсация: 400₽ (по старой цене)
- Осталось: 3600₽ - 400₽ = 3200₽
```

---

## 📝 Рекомендации

### Для тренеров:

1. **Используйте "Перенос" ответственно**
   - Только для уважительных причин
   - Когда реально договорились об отработке

2. **Проверяйте компенсации**
   - Открывайте страницу платежей следующего месяца
   - Убеждайтесь, что компенсации создались

3. **Удаляйте лишние компенсации**
   - Если передумали насчет переноса
   - Используйте "Отменить оплату" на странице платежей

---

### Для администраторов:

1. **Контролируйте цены**
   - Обновляйте цены в SubscriptionPrice
   - Проверяйте актуальность перед новым месяцем

2. **Следите за балансом**
   - Проверяйте, что компенсации разумны
   - Выявляйте злоупотребления

3. **Информируйте родителей**
   - Объясните систему компенсаций
   - Покажите, как это видно в платежах

---

## ✅ Итоговое резюме

### Что делает функция:

| Действие | Результат |
|----------|-----------|
| **Отметка "Перенос"** | Создается компенсация на следующий месяц |
| **Сумма** | Стоимость 1 занятия (цена / 8 или / 12) |
| **Дата** | 1-е число следующего месяца |
| **Влияние на оплату** | Уменьшает сумму к оплате в следующем месяце |

### Преимущества:

✅ **Справедливость** - ученик не теряет оплаченные занятия  
✅ **Автоматизация** - не нужно вручную создавать компенсации  
✅ **Прозрачность** - все видно на странице платежей  
✅ **Гибкость** - работает для любых типов абонементов  

---

**Дата:** 2025-10-06  
**Версия:** 1.0  
**Статус:** ✅ РЕАЛИЗОВАНО
