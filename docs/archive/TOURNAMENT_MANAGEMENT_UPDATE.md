# 🏆 Обновление управления турнирами

## ✨ Что добавлено

### 1. Кнопка "Редактировать турнир"
- **Расположение:** Рядом с каждым турниром в карточке
- **Внешний вид:** ✏️ Редактировать (серая кнопка)
- **Функция:** Открывает модальное окно для редактирования турнира

### 2. Кнопка "Удалить турнир"
- **Расположение:** Рядом с каждым турниром в карточке
- **Внешний вид:** 🗑️ Удалить (красная кнопка)
- **Функция:** Удаляет турнир и всех его участников

### 3. Кнопка "Создать турнир" перемещена направо
- **Было:** Слева от заголовка
- **Стало:** Справа от заголовка (выровнена по правому краю)

---

## 🎨 Новый интерфейс

### Заголовок страницы:
```
┌────────────────────────────────────────────────────────────────┐
│ Турниры                        [+ Создать турнир] ←─ справа   │
└────────────────────────────────────────────────────────────────┘
```

### Карточка турнира:
```
┌────────────────────────────────────────────────────────────────┐
│ Первенство города по самбо                                     │
│ 📍 Спорткомплекс "Олимп" • 📅 15.10.2025                      │
│                                                                 │
│ [+ Участник] [✏️ Редактировать] [🗑️ Удалить] ←─ 3 кнопки      │
│                                                                 │
│ Описание турнира...                                            │
│ [Показать результаты]                                          │
└────────────────────────────────────────────────────────────────┘
```

---

## 🔧 Технические изменения

### Frontend (templates/tournaments.html)

#### 1. Добавлено модальное окно редактирования:
```html
<div id="editTournamentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Редактировать турнир</h2>
            <button class="modal-close">&times;</button>
        </div>
        <form id="editTournamentForm">
            <input type="hidden" id="editTournamentIdInput">
            <!-- Поля: название, дата, место, описание -->
            <button type="submit">Сохранить</button>
            <button type="button">Отмена</button>
        </form>
    </div>
</div>
```

#### 2. Добавлены кнопки в карточку турнира:
```javascript
<div class="flex gap-1">
    <button class="btn btn-primary btn-sm" onclick="openAddParticipantModal('...')">
        + Участник
    </button>
    <button class="btn btn-outline btn-sm" onclick="openEditTournamentModal('...')">
        ✏️ Редактировать
    </button>
    <button class="btn btn-danger btn-sm" onclick="deleteTournament('...')">
        🗑️ Удалить
    </button>
</div>
```

#### 3. Добавлена функция редактирования:
```javascript
function openEditTournamentModal(tournamentId) {
    const tournament = tournaments.find(t => t.id === tournamentId);
    // Заполняем форму
    document.getElementById('editTournamentIdInput').value = tournament.id;
    document.getElementById('editTournamentName').value = tournament.name;
    document.getElementById('editTournamentDate').value = tournament.tournament_date;
    document.getElementById('editTournamentLocation').value = tournament.location;
    document.getElementById('editTournamentDescription').value = tournament.description || '';
    
    modal.open('editTournamentModal');
}
```

#### 4. Добавлен обработчик отправки формы редактирования:
```javascript
document.getElementById('editTournamentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const tournamentId = document.getElementById('editTournamentIdInput').value;
    const data = {
        name: formData.get('name'),
        tournament_date: formData.get('tournament_date'),
        location: formData.get('location'),
        description: formData.get('description') || null
    };
    
    await api.put(`/tournaments/${tournamentId}`, data);
    modal.close('editTournamentModal');
    await loadTournaments();
    ui.showSuccess('Турнир обновлен');
});
```

#### 5. Добавлена функция удаления:
```javascript
async function deleteTournament(tournamentId) {
    const tournament = tournaments.find(t => t.id === tournamentId);
    if (!ui.confirm(`Вы уверены, что хотите удалить турнир "${tournament.name}"? Это также удалит всех участников.`)) {
        return;
    }
    
    await api.delete(`/tournaments/${tournamentId}`);
    await loadTournaments();
    ui.showSuccess('Турнир удален');
}
```

---

### Backend (app/api/tournaments.py)

#### Добавлен DELETE endpoint:
```python
@router.delete("/{tournament_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_tournament(
    tournament_id: uuid.UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Delete a tournament and all its participants."""
    result = await db.execute(select(Tournament).where(Tournament.id == tournament_id))
    tournament = result.scalar_one_or_none()
    
    if not tournament:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tournament not found"
        )
    
    # Delete tournament (participants will be deleted automatically due to cascade)
    await db.delete(tournament)
    await db.commit()
    
    return None
```

**Важно:** Благодаря каскадному удалению в модели, при удалении турнира автоматически удаляются все его участники.

---

## 📋 API Endpoints

### Существующие (используются):

| Метод | URL | Описание |
|-------|-----|----------|
| GET | `/api/tournaments` | Получить все турниры |
| POST | `/api/tournaments` | Создать турнир |
| **PUT** | `/api/tournaments/{id}` | **Обновить турнир** ✅ |
| **DELETE** | `/api/tournaments/{id}` | **Удалить турнир** ✅ (добавлен) |

### Также используются:

| Метод | URL | Описание |
|-------|-----|----------|
| GET | `/api/tournaments/{id}/results` | Результаты турнира |
| POST | `/api/tournaments/{id}/participants` | Добавить участника |
| PUT | `/api/tournaments/{id}/participants/{pid}` | Обновить участника |
| DELETE | `/api/tournaments/{id}/participants/{pid}` | Удалить участника |

---

## 💡 Как это работает

### Редактирование турнира:

1. **Пользователь нажимает "✏️ Редактировать"**
2. Открывается модальное окно с формой
3. Поля автоматически заполняются текущими данными
4. Пользователь меняет нужные поля
5. Нажимает "Сохранить"
6. **→ PUT /api/tournaments/{id}**
7. Список турниров обновляется
8. Показывается уведомление "Турнир обновлен"

---

### Удаление турнира:

1. **Пользователь нажимает "🗑️ Удалить"**
2. Показывается подтверждение:
   ```
   Вы уверены, что хотите удалить турнир "Первенство города"?
   Это также удалит всех участников.
   ```
3. Пользователь подтверждает
4. **→ DELETE /api/tournaments/{id}**
5. Турнир и все его участники удаляются из БД
6. Список турниров обновляется
7. Показывается уведомление "Турнир удален"

---

## ⚠️ Важные моменты

### 1. Каскадное удаление

При удалении турнира **автоматически удаляются**:
- Все участники турнира
- Все результаты
- Все связанные данные

**Это безопасно**, так как определено в модели:
```python
participations: Mapped[list["TournamentParticipation"]] = relationship(
    "TournamentParticipation",
    back_populates="tournament",
    cascade="all, delete-orphan"  # ← Каскадное удаление
)
```

---

### 2. Подтверждение удаления

Система **обязательно** запрашивает подтверждение перед удалением:
```javascript
if (!ui.confirm(`Вы уверены...?`)) {
    return; // Отмена
}
```

**Нельзя** случайно удалить турнир одним кликом.

---

### 3. Безопасность

Все операции требуют:
- ✅ Авторизацию (`current_user: User = Depends(get_current_user)`)
- ✅ Проверку существования турнира
- ✅ Подтверждение от пользователя (удаление)

---

### 4. Редактирование vs Удаление

**Редактирование:**
- Можно изменить: название, дату, место, описание
- **Нельзя изменить:** участников (это делается отдельно)

**Удаление:**
- Удаляет турнир **полностью**
- Восстановить нельзя
- Удаляет всех участников

---

## 🎯 Примеры использования

### Пример 1: Исправить опечатку в названии

**Ситуация:**
Создали турнир с названием "Первенстов города" (опечатка)

**Действия:**
1. Нажать "✏️ Редактировать"
2. Исправить название на "Первенство города"
3. Нажать "Сохранить"
4. ✅ Название исправлено

---

### Пример 2: Перенос турнира

**Ситуация:**
Турнир перенесли с 15.10 на 22.10

**Действия:**
1. Нажать "✏️ Редактировать"
2. Изменить дату на 22.10.2025
3. Нажать "Сохранить"
4. ✅ Дата обновлена, участники остались

---

### Пример 3: Отмена турнира

**Ситуация:**
Турнир отменили из-за форс-мажора

**Действия:**
1. Нажать "🗑️ Удалить"
2. Подтвердить удаление
3. ✅ Турнир и все участники удалены

---

### Пример 4: Создали турнир по ошибке

**Ситуация:**
Случайно создали дубликат турнира

**Действия:**
1. Нажать "🗑️ Удалить" на дубликате
2. Подтвердить
3. ✅ Дубликат удален

---

## 🧪 Тестирование

### Проверьте редактирование:

1. **Откройте страницу Турниры:**
   ```
   http://localhost:8000/tournaments
   ```

2. **Нажмите "✏️ Редактировать" на любом турнире**

3. **Проверьте:**
   - ✅ Открылось модальное окно
   - ✅ Поля заполнены текущими данными
   - ✅ Можно изменить название
   - ✅ Можно изменить дату
   - ✅ Можно изменить место
   - ✅ Можно изменить описание

4. **Измените что-то и нажмите "Сохранить"**

5. **Проверьте результат:**
   - ✅ Модальное окно закрылось
   - ✅ Список турниров обновился
   - ✅ Изменения видны в карточке
   - ✅ Показалось уведомление

---

### Проверьте удаление:

1. **Создайте тестовый турнир**

2. **Нажмите "🗑️ Удалить"**

3. **Проверьте:**
   - ✅ Показалось окно подтверждения
   - ✅ В тексте упоминается название турнира
   - ✅ Предупреждение об удалении участников

4. **Подтвердите удаление**

5. **Проверьте результат:**
   - ✅ Турнир исчез из списка
   - ✅ Показалось уведомление
   - ✅ Список обновился

---

### Проверьте кнопку "Создать турнир":

1. **Откройте страницу Турниры**

2. **Проверьте:**
   - ✅ Кнопка "+ Создать турнир" **справа** от заголовка
   - ✅ Кнопка выровнена по правому краю

---

## 📝 Изменённые файлы

### Frontend:
✅ `templates/tournaments.html`
- Добавлено модальное окно редактирования
- Добавлены кнопки в карточку турнира
- Добавлена функция `openEditTournamentModal()`
- Добавлена функция `deleteTournament()`
- Добавлен обработчик формы редактирования
- Изменено расположение кнопки "Создать турнир"

### Backend:
✅ `app/api/tournaments.py`
- Добавлен endpoint `DELETE /api/tournaments/{id}`

---

## ✅ Итоговый список возможностей

### Управление турниром:

| Действие | Кнопка | Где |
|----------|--------|-----|
| **Создать турнир** | + Создать турнир | Заголовок страницы (справа) |
| **Редактировать турнир** | ✏️ Редактировать | Карточка турнира |
| **Удалить турнир** | 🗑️ Удалить | Карточка турнира |
| **Добавить участника** | + Участник | Карточка турнира |
| **Показать результаты** | Показать результаты | Карточка турнира |

### Управление участниками:

| Действие | Кнопка | Где |
|----------|--------|-----|
| **Редактировать участника** | Редактировать | Таблица результатов |
| **Удалить участника** | Удалить | Таблица результатов |

---

## 🎉 Преимущества

✅ **Полное управление турнирами** - можно создавать, редактировать, удалять  
✅ **Удобный интерфейс** - все кнопки на виду  
✅ **Безопасность** - подтверждение перед удалением  
✅ **Гибкость** - можно исправить любую ошибку  
✅ **Интуитивность** - понятные иконки и названия  

---

**Дата:** 2025-10-06  
**Версия:** 1.0  
**Статус:** ✅ РЕАЛИЗОВАНО И ПРОТЕСТИРОВАНО
