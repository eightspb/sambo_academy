# 📋 Статус "Перенос" при отметке посещаемости

## 🎯 Что происходит при установке статуса "Перенос"

Когда вы отмечаете ученика статусом **"→ Перенос"** (transferred), в системе происходит следующее:

---

## ✅ Что ДЕЛАЕТ статус "Перенос"

### 1. Сохраняет информацию о посещении
Создается запись в таблице `attendances` со статусом `TRANSFERRED`:
```python
Attendance(
    student_id=...,
    group_id=...,
    session_date=...,
    status=AttendanceStatus.TRANSFERRED,  # "transferred"
    subscription_id=...,
    marked_by=...
)
```

### 2. Учитывается в статистике
На странице **Статистика** переносы отображаются отдельной колонкой:

| Группа | Всего | Присутствовали | Отсутствовали | **Перенос** | % Посещаемости |
|--------|-------|---------------|--------------|------------|---------------|
| Младшие | 20 | 15 | 3 | **2** | 75% |

**Желтым бейджем** (badge-warning) - чтобы отличить от присутствия и отсутствия.

### 3. НЕ влияет на процент посещаемости
**Важно:** При расчете процента посещаемости переносы **НЕ учитываются**:

```javascript
// Расчет процента
attendance_rate = (present / total * 100)

// Где:
// present - только "Присутствовал"
// total - все записи (присутствовал + отсутствовал + перенос)
```

**Пример:**
- Всего занятий: 20
- Присутствовал: 15
- Отсутствовал: 3
- **Перенос: 2**
- **Процент посещаемости: 75%** (15/20, а не 17/20)

---

## ❌ Что НЕ ДЕЛАЕТ статус "Перенос"

### 1. НЕ списывает занятие с абонемента

**Код из API:**
```python
# Update subscription if present and not transferred
if subscription and status_value == AttendanceStatus.PRESENT:
    if subscription.remaining_sessions > 0:
        subscription.remaining_sessions -= 1
```

**Это значит:**
- ✅ **"Присутствовал"** → списывается 1 занятие
- ❌ **"Перенос"** → НЕ списывается
- ❌ **"Отсутствовал"** → НЕ списывается

**Пример:**
```
Абонемент: 8 занятий

День 1: Присутствовал → осталось 7 занятий
День 2: Перенос       → осталось 7 занятий (не изменилось!)
День 3: Отсутствовал  → осталось 7 занятий (не изменилось!)
День 4: Присутствовал → осталось 6 занятий
```

### 2. НЕ создает компенсационное занятие

Статус "Перенос" - это **просто отметка**, что занятие было перенесено. Он **не создает** автоматически:
- Новую дату занятия
- Дополнительное занятие в абонементе
- Напоминание о переносе

### 3. НЕ влияет на платежи

Переносы никак не влияют на:
- Расчет стоимости абонемента
- Отображение на странице платежей
- Статус оплаты

---

## 🤔 Когда использовать "Перенос"

### Рекомендуемые сценарии:

#### 1. Ученик предупредил о пропуске
```
Ситуация: Родитель позвонил, что ребенок болен
Действие: Ставим "Перенос"
Результат: 
  - Видим в статистике, что это не просто прогул
  - Абонемент не списывается
  - Можно провести занятие позже
```

#### 2. Групповой перенос тренировки
```
Ситуация: Тренировка перенесена на другой день из-за праздника
Действие: Всем ставим "Перенос"
Результат:
  - Все абонементы остаются без изменений
  - В статистике видно, что была уважительная причина
```

#### 3. Индивидуальная договоренность
```
Ситуация: Договорились, что ученик придет на другое занятие
Действие: Ставим "Перенос"
Результат:
  - Не списываем с абонемента
  - Отмечаем факт переноса
```

---

## 🚫 Когда НЕ использовать "Перенос"

### НЕ рекомендуется:

#### 1. Обычный прогул
```
Ситуация: Ученик не пришел, не предупредил
Действие: "Отсутствовал"
НЕ "Перенос": Это не перенос, а пропуск
```

#### 2. Ученик пришел
```
Ситуация: Ученик присутствовал на занятии
Действие: "Присутствовал"
НЕ "Перенос": Занятие состоялось, нужно списать с абонемента
```

#### 3. Компенсация пропусков
```
Ситуация: Ученик пропустил 3 занятия, хотим компенсировать
Действие: Это нужно решать через платежи/абонементы
НЕ "Перенос": Перенос не добавляет занятия
```

---

## 📊 Как это выглядит в интерфейсе

### Страница "Посещаемость"

```
┌─────────────────────────────────────────┐
│ Иванов Иван                             │
│ ✓ Присутствовал  ✗ Отсутствовал → Перенос│
│         ▲               ▲            ▲   │
│      зеленая        красная      желтая  │
│      рамка          рамка        рамка   │
└─────────────────────────────────────────┘
```

### Страница "Статистика"

```
┌──────────────────────────────────────────────────────┐
│ Группа          Всего  Присут. Отсут.  Перенос  %   │
├──────────────────────────────────────────────────────┤
│ Младшие ПН-СР-ПТ  20     15      3       2      75% │
│                          🟢      🔴      🟡           │
└──────────────────────────────────────────────────────┘
```

---

## 💡 Практические примеры

### Пример 1: Болезнь ученика

**Действия:**
1. Ученик заболел, родитель предупредил
2. Тренер ставит "Перенос" вместо "Отсутствовал"
3. Абонемент: осталось 5 занятий (было 5)
4. Через неделю ученик выздоровел
5. Приходит на дополнительное занятие в другой группе
6. Тренер ставит "Присутствовал"
7. Абонемент: осталось 4 занятия

**Итого:** Ученик не потерял занятие из-за болезни.

---

### Пример 2: Праздник

**Действия:**
1. 23 февраля - выходной
2. Тренировка перенесена на 24 февраля
3. 23.02: всем ставим "Перенос"
4. 24.02: всем кто пришел ставим "Присутствовал"

**Результат:**
- В статистике видно, что 23.02 была уважительная причина
- Абонементы списываются только за 24.02
- Процент посещаемости не пострадал

---

### Пример 3: Индивидуальный подход

**Ученик:** Матвей (абонемент: 8 занятий)

| Дата | Действие | Статус | Осталось занятий |
|------|----------|--------|------------------|
| 01.10 | Пришел | Присутствовал | 7 |
| 03.10 | Предупредил о пропуске | **Перенос** | **7** |
| 05.10 | Пришел | Присутствовал | 6 |
| 08.10 | Пришел на другую группу | Присутствовал | 5 |

**Объяснение:**
- 03.10: Поставили "Перенос" - занятие не списалось
- 08.10: Пришел на другую группу (отработка) - занятие списалось
- Матвей получил свои 8 занятий по факту

---

## 🔍 Техническая информация

### База данных

```sql
-- Таблица attendances
CREATE TABLE attendances (
    id UUID PRIMARY KEY,
    student_id UUID,
    group_id UUID,
    session_date DATE,
    status VARCHAR,  -- 'present', 'absent', 'transferred'
    subscription_id UUID,
    marked_by UUID,
    notes TEXT,
    created_at TIMESTAMP
);
```

### Enum статусы

```python
class AttendanceStatus(str, Enum):
    PRESENT = "present"        # Присутствовал
    ABSENT = "absent"          # Отсутствовал
    TRANSFERRED = "transferred" # Перенос
```

### Логика списания с абонемента

```python
# Файл: app/api/attendance.py

# Update subscription if present and not transferred
if subscription and status_value == AttendanceStatus.PRESENT:
    if subscription.remaining_sessions > 0:
        subscription.remaining_sessions -= 1
```

**Ключевое:** Списывание происходит **ТОЛЬКО** при статусе `PRESENT`.

---

## ⚠️ Важные моменты

### 1. Ответственность тренера

Статус "Перенос" - это инструмент учета, но:
- **Не создает** автоматически компенсационное занятие
- **Не напоминает** о необходимости отработки
- **Не контролирует** фактическую отработку

**Тренер должен:**
- Вручную отслеживать переносы
- Договариваться с учениками об отработках
- Отмечать фактическую явку на отработку

### 2. Статистика

Переносы показывают:
- Дисциплину учеников (предупреждают или нет)
- Объективные обстоятельства (праздники, болезни)
- Качество взаимодействия с родителями

**Но НЕ влияют на:**
- Процент посещаемости (считается только по присутствиям)
- Финансовую статистику
- Автоматические отчеты

### 3. Гибкость системы

Систему можно использовать по-разному:
- **Строго:** Перенос = гарантия отработки
- **Мягко:** Перенос = просто информация об уважительной причине
- **Индивидуально:** Решаете в каждом случае

---

## 📝 Рекомендации

### Для тренеров:

1. **Договаривайтесь заранее**
   - Объясните родителям, что такое "Перенос"
   - Установите правила отработок

2. **Ведите учет**
   - Записывайте, кому и когда нужна отработка
   - Проверяйте статистику переносов

3. **Будьте последовательны**
   - Если ставите "Перенос" - давайте отработку
   - Если не даете отработки - ставьте "Отсутствовал"

### Для администраторов:

1. **Обучите тренеров**
   - Объясните разницу между статусами
   - Покажите влияние на абонементы

2. **Контролируйте использование**
   - Проверяйте статистику переносов
   - Выявляйте злоупотребления

3. **Устанавливайте правила**
   - Максимум переносов в месяц
   - Сроки отработок
   - Документирование

---

## ✅ Краткое резюме

### Статус "Перенос":

| Параметр | Значение |
|----------|----------|
| **Списывает занятие** | ❌ НЕТ |
| **Учитывается в статистике** | ✅ ДА (отдельно) |
| **Влияет на % посещаемости** | ❌ НЕТ |
| **Создает компенсацию** | ❌ НЕТ |
| **Помогает учету** | ✅ ДА |

### Когда использовать:

✅ Болезнь (с предупреждением)  
✅ Праздники/переносы  
✅ Договоренности об отработке  
❌ Обычные прогулы  
❌ Компенсации (это через платежи)  

---

**Дата:** 2025-10-06  
**Версия:** 1.0  
**Статус:** ✅ ДОКУМЕНТАЦИЯ
