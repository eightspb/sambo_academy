<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—É—Ä–Ω–∏—Ä—ã - Sambo Academy</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Header Component -->
    <div id="app-header"></div>
    
    <!-- Navigation Component -->
    <div id="app-nav"></div>
    
    <main class="container">
        <div class="flex-between mb-2">
            <h1>–¢—É—Ä–Ω–∏—Ä—ã</h1>
            <button class="btn btn-primary" onclick="openCreateTournamentModal()">+ –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>
        </div>
        
        <div id="tournamentsList">
            <div class="spinner"></div>
        </div>
    </main>
    
    <!-- Create Tournament Modal -->
    <div id="createTournamentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä</h2>
                <button class="modal-close" onclick="modal.close('createTournamentModal')">&times;</button>
            </div>
            <form id="createTournamentForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                    <input type="date" name="tournament_date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</label>
                    <input type="text" name="location" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" class="form-textarea" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Tournament Modal -->
    <div id="editTournamentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä</h2>
                <button class="modal-close" onclick="modal.close('editTournamentModal')">&times;</button>
            </div>
            <form id="editTournamentForm">
                <input type="hidden" id="editTournamentIdInput">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                    <input type="text" name="name" id="editTournamentName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                    <input type="date" name="tournament_date" id="editTournamentDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</label>
                    <input type="text" name="location" id="editTournamentLocation" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" id="editTournamentDescription" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="flex gap-1">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-outline" onclick="modal.close('editTournamentModal')">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Participant Modal -->
    <div id="addParticipantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
                <button class="modal-close" onclick="modal.close('addParticipantModal')">&times;</button>
            </div>
            <form id="addParticipantForm">
                <input type="hidden" id="selectedTournamentId" name="tournament_id">
                
                <div class="form-group">
                    <label class="form-label">–£—á–µ–Ω–∏–∫</label>
                    <select name="student_id" id="studentSelect" class="form-select" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–µ—Å—Ç–æ</label>
                    <input type="number" name="place" id="addPlace" class="form-input" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ö–≤–∞—Ç–æ–∫</label>
                    <input type="number" name="total_fights" id="addTotalFights" class="form-input" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ–±–µ–¥</label>
                    <input type="number" name="wins" id="addWins" class="form-input" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</label>
                    <input type="number" name="losses" id="addLosses" class="form-input" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–í–µ—Å–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <input type="text" name="weight_category" id="addWeightCategory" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea name="notes" id="addNotes" class="form-textarea" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Participant Modal -->
    <div id="editParticipantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
                <button class="modal-close" onclick="modal.close('editParticipantModal')">&times;</button>
            </div>
            <form id="editParticipantForm">
                <input type="hidden" id="editTournamentId">
                <input type="hidden" id="editParticipationId">
                
                <div class="form-group">
                    <label class="form-label">–£—á–µ–Ω–∏–∫</label>
                    <input type="text" id="editStudentName" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–µ—Å—Ç–æ</label>
                    <input type="number" name="place" id="editPlace" class="form-input" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ö–≤–∞—Ç–æ–∫</label>
                    <input type="number" name="total_fights" id="editTotalFights" class="form-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ–±–µ–¥</label>
                    <input type="number" name="wins" id="editWins" class="form-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</label>
                    <input type="number" name="losses" id="editLosses" class="form-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–í–µ—Å–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <input type="text" name="weight_category" id="editWeightCategory" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea name="notes" id="editNotes" class="form-textarea" rows="2"></textarea>
                </div>
                <div class="flex gap-1">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-outline" onclick="modal.close('editParticipantModal')">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    <script src="/static/js/components.js"></script>
    
    <script src="/static/js/app.js"></script>
    <script>
        let tournaments = [];
        let students = [];
        let currentTournamentResults = {};
        
        async function loadData() {
            await auth.checkAuth();
            
            try {
                const user = await api.get('/auth/me');
                document.getElementById('userName').textContent = user.full_name;
                
                students = await api.get('/students?is_active=true');
                populateStudentSelect();
                
                await loadTournaments();
            } catch (error) {
                ui.showError(error.message);
            }
        }
        
        function populateStudentSelect() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = students.map(s => 
                `<option value="${s.id}">${s.full_name}</option>`
            ).join('');
        }
        
        async function loadTournaments() {
            try {
                tournaments = await api.get('/tournaments');
                renderTournaments();
            } catch (error) {
                ui.showError(error.message);
            }
        }
        
        function renderTournaments() {
            const container = document.getElementById('tournamentsList');
            
            if (tournaments.length === 0) {
                container.innerHTML = '<div class="card"><p class="text-secondary">–¢—É—Ä–Ω–∏—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';
                return;
            }
            
            container.innerHTML = tournaments.map(tournament => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">${tournament.name}</h2>
                            <p class="text-secondary">
                                üìç ${tournament.location} ‚Ä¢ üìÖ ${dateUtils.formatDate(tournament.tournament_date)}
                            </p>
                        </div>
                        <div class="flex gap-1">
                            <button class="btn btn-primary btn-sm" onclick="openAddParticipantModal('${tournament.id}')">
                                + –£—á–∞—Å—Ç–Ω–∏–∫
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="openEditTournamentModal('${tournament.id}')">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTournament('${tournament.id}')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    ${tournament.description ? `<p>${tournament.description}</p>` : ''}
                    <div id="results_${tournament.id}">
                        <button class="btn btn-outline btn-sm mt-1" onclick="loadTournamentResults('${tournament.id}')">
                            –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadTournamentResults(tournamentId) {
            try {
                const results = await api.get(`/tournaments/${tournamentId}/results`);
                const container = document.getElementById(`results_${tournamentId}`);
                
                // Store results for editing
                currentTournamentResults[tournamentId] = results;
                
                if (results.length === 0) {
                    container.innerHTML = '<p class="text-secondary mt-1">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table mt-1">
                        <thead>
                            <tr>
                                <th>–ú–µ—Å—Ç–æ</th>
                                <th>–£—á–µ–Ω–∏–∫</th>
                                <th>–°—Ö–≤–∞—Ç–æ–∫</th>
                                <th>–ü–æ–±–µ–¥</th>
                                <th>–ü–æ—Ä–∞–∂–µ–Ω–∏–π</th>
                                <th>–í–µ—Å–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map((result, index) => `
                                <tr>
                                    <td><strong>${result.place || '-'}</strong></td>
                                    <td>${result.student_name}</td>
                                    <td>${result.total_fights}</td>
                                    <td><span class="badge badge-success">${result.wins}</span></td>
                                    <td><span class="badge badge-danger">${result.losses}</span></td>
                                    <td>${result.weight_category || '-'}</td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button class="btn btn-sm btn-outline" onclick="openEditParticipantModal('${tournamentId}', '${result.id}', ${index})">
                                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteParticipant('${tournamentId}', '${result.id}')">
                                                –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                ui.showError(error.message);
            }
        }
        
        function openCreateTournamentModal() {
            modal.open('createTournamentModal');
        }
        
        async function openAddParticipantModal(tournamentId) {
            document.getElementById('selectedTournamentId').value = tournamentId;
            
            // Get already added participants
            try {
                const results = await api.get(`/tournaments/${tournamentId}/results`);
                const addedStudentIds = new Set(results.map(r => r.student_id));
                
                // Filter out already added students
                const select = document.getElementById('studentSelect');
                select.innerHTML = students
                    .filter(s => !addedStudentIds.has(s.id))
                    .map(s => `<option value="${s.id}">${s.full_name}</option>`)
                    .join('');
                
                if (select.options.length === 0) {
                    select.innerHTML = '<option value="">–í—Å–µ —É—á–µ–Ω–∏–∫–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</option>';
                    ui.showError('–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏ —É–∂–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —ç—Ç–æ–º —Ç—É—Ä–Ω–∏—Ä–µ');
                    return;
                }
            } catch (error) {
                console.error('Error loading participants:', error);
                // If error, show all students
                populateStudentSelect();
            }
            
            modal.open('addParticipantModal');
        }
        
        document.getElementById('createTournamentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                tournament_date: formData.get('tournament_date'),
                location: formData.get('location'),
                description: formData.get('description') || null
            };
            
            try {
                ui.showLoading();
                await api.post('/tournaments', data);
                ui.hideLoading();
                
                modal.close('createTournamentModal');
                e.target.reset();
                loadTournaments();
                ui.showSuccess('–¢—É—Ä–Ω–∏—Ä —Å–æ–∑–¥–∞–Ω');
            } catch (error) {
                ui.hideLoading();
                ui.showError(error.message);
            }
        });
        
        document.getElementById('addParticipantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const tournamentId = document.getElementById('selectedTournamentId').value;
            
            const data = {
                student_id: formData.get('student_id'),
                place: formData.get('place') ? parseInt(formData.get('place')) : null,
                total_fights: parseInt(formData.get('total_fights')),
                wins: parseInt(formData.get('wins')),
                losses: parseInt(formData.get('losses')),
                weight_category: formData.get('weight_category') || null,
                notes: formData.get('notes') || null
            };
            
            try {
                ui.showLoading();
                await api.post(`/tournaments/${tournamentId}/participants`, data);
                ui.hideLoading();
                
                modal.close('addParticipantModal');
                e.target.reset();
                loadTournamentResults(tournamentId);
                ui.showSuccess('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
            } catch (error) {
                ui.hideLoading();
                ui.showError(error.message);
            }
        });
        
        function openEditParticipantModal(tournamentId, participationId, resultIndex) {
            const result = currentTournamentResults[tournamentId][resultIndex];
            
            document.getElementById('editTournamentId').value = tournamentId;
            document.getElementById('editParticipationId').value = participationId;
            document.getElementById('editStudentName').value = result.student_name;
            document.getElementById('editPlace').value = result.place || '';
            document.getElementById('editTotalFights').value = result.total_fights;
            document.getElementById('editWins').value = result.wins;
            document.getElementById('editLosses').value = result.losses;
            document.getElementById('editWeightCategory').value = result.weight_category || '';
            document.getElementById('editNotes').value = result.notes || '';
            
            modal.open('editParticipantModal');
        }
        
        document.getElementById('editParticipantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tournamentId = document.getElementById('editTournamentId').value;
            const participationId = document.getElementById('editParticipationId').value;
            
            const formData = new FormData(e.target);
            const data = {
                place: formData.get('place') ? parseInt(formData.get('place')) : null,
                total_fights: parseInt(formData.get('total_fights')),
                wins: parseInt(formData.get('wins')),
                losses: parseInt(formData.get('losses')),
                weight_category: formData.get('weight_category') || null,
                notes: formData.get('notes') || null
            };
            
            try {
                ui.showLoading();
                await api.put(`/tournaments/${tournamentId}/participants/${participationId}`, data);
                ui.hideLoading();
                
                modal.close('editParticipantModal');
                loadTournamentResults(tournamentId);
                ui.showSuccess('–£—á–∞—Å—Ç–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                ui.hideLoading();
                ui.showError(error.message);
            }
        });
        
        async function deleteParticipant(tournamentId, participationId) {
            if (!ui.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) {
                return;
            }
            
            try {
                ui.showLoading();
                await api.delete(`/tournaments/${tournamentId}/participants/${participationId}`);
                ui.hideLoading();
                
                loadTournamentResults(tournamentId);
                ui.showSuccess('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω');
            } catch (error) {
                ui.hideLoading();
                ui.showError(error.message);
            }
        }
        
        function openEditTournamentModal(tournamentId) {
            const tournament = tournaments.find(t => t.id === tournamentId);
            if (!tournament) return;
            
            document.getElementById('editTournamentIdInput').value = tournament.id;
            document.getElementById('editTournamentName').value = tournament.name;
            document.getElementById('editTournamentDate').value = tournament.tournament_date;
            document.getElementById('editTournamentLocation').value = tournament.location;
            document.getElementById('editTournamentDescription').value = tournament.description || '';
            
            modal.open('editTournamentModal');
        }
        
        document.getElementById('editTournamentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tournamentId = document.getElementById('editTournamentIdInput').value;
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                tournament_date: formData.get('tournament_date'),
                location: formData.get('location'),
                description: formData.get('description') || null
            };
            
            try {
                ui.showLoading();
                await api.put(`/tournaments/${tournamentId}`, data);
                ui.hideLoading();
                
                modal.close('editTournamentModal');
                await loadTournaments();
                ui.showSuccess('–¢—É—Ä–Ω–∏—Ä –æ–±–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                ui.hideLoading();
                ui.showError(error.message);
            }
        });
        
        async function deleteTournament(tournamentId) {
            const tournament = tournaments.find(t => t.id === tournamentId);
            if (!ui.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä "${tournament.name}"? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.`)) {
                return;
            }
            
            try {
                ui.showLoading();
                await api.delete(`/tournaments/${tournamentId}`);
                ui.hideLoading();
                
                await loadTournaments();
                ui.showSuccess('–¢—É—Ä–Ω–∏—Ä —É–¥–∞–ª–µ–Ω');
            } catch (error) {
                ui.hideLoading();
                ui.showError(error.message);
            }
        }
        
        loadData();
    </script>
</body>
</html>
